<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ</title>
    <style>
        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© - Modern UI Design */
        :root {
            --bg: #f0f2f5;
            --card: #ffffff;
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --danger: #ef4444;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; 
            padding: 0; 
            line-height: 1.6;
        }

        .container { 
            max-width: 850px; 
            margin: 40px auto; 
            padding: 20px; 
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login_screen { 
            background: var(--card); 
            padding: 40px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            text-align: center;
            border-top: 5px solid var(--primary);
        }

        #login_screen h2 { color: var(--primary); margin-bottom: 10px; }
        #login_screen p { color: var(--text-muted); margin-bottom: 25px; }

        input, select, textarea { 
            width: 100%; 
            padding: 14px; 
            margin: 12px 0; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: all 0.3s ease;
            box-sizing: border-box;
            outline: none;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† */
        #exam_screen { display: none; }
        
        .exam-header { 
            position: sticky; 
            top: 20px; 
            background: var(--card); 
            padding: 20px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            z-index: 100;
            border-right: 5px solid var(--primary);
        }

        .timer { 
            font-size: 22px; 
            font-weight: 800; 
            color: var(--danger); 
            background: #fef2f2;
            padding: 5px 15px;
            border-radius: 30px;
            border: 1px solid #fee2e2;
        }

        .question-card { 
            background: var(--card); 
            padding: 30px; 
            border-radius: var(--radius); 
            margin-bottom: 25px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .question-card p {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #334155;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø§Ø¯ÙŠÙˆ Ø¨ÙˆØªÙˆÙ† */
        label {
            display: block;
            margin: 12px 0;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        label:hover {
            background-color: #f8fafc;
            border-color: var(--primary);
        }

        input[type="radio"] {
            width: auto;
            margin-left: 10px;
            accent-color: var(--primary);
        }

        textarea { height: 120px; resize: vertical; }

        .btn { 
            padding: 15px 35px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 16px;
            background: var(--primary); 
            color: white; 
            transition: background 0.3s ease;
            display: inline-block;
        }

        .btn:hover { background: var(--primary-hover); }

        /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        #warning_overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.95); color: white; z-index: 999; 
            flex-direction: column; align-items: center; justify-content: center; text-align: center;
            backdrop-filter: blur(5px);
        }

        #warning_overlay h1 { font-size: 50px; color: var(--danger); margin-bottom: 20px; }
        #warning_overlay p { font-size: 20px; max-width: 500px; margin-bottom: 30px; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© */
        .end-screen {
            text-align: center;
            background: white;
            padding: 50px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
    </style>
</head>
<body>

<div class="container">
    <div id="login_screen">
        <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
        <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø¯Ù‚Ø© Ù„Ù„Ø¨Ø¯Ø¡</p>
        <input type="text" id="student_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
        <input type="text" id="student_code" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
        <select id="exam_selector">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± --</option>
        </select>
        <br><br>
        <button class="btn" onclick="startExam()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†</button>
    </div>

    <div id="exam_screen">
        <div class="exam-header">
            <h3 id="display_exam_title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
            <div class="timer" id="timer_display">00:00</div>
        </div>
        <div id="questions_container"></div>
        <div style="text-align: center; margin-top: 40px;">
            <button class="btn" onclick="submitExam('manual')">Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
        </div>
    </div>
</div>

<div id="warning_overlay">
    <h1>âš ï¸ ØªØ­Ø°ÙŠØ± ØºØ´!</h1>
    <p>Ù„Ù‚Ø¯ Ø­Ø§ÙˆÙ„Øª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©. Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†..</p>
    <p style="color: #ff9999;"><strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø¥Ø°Ø§ ØºØ§Ø¯Ø±Øª Ø§Ù„ØµÙØ­Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŒ Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ùƒ ÙÙˆØ±Ø§Ù‹ ÙˆØªØ³Ø¬ÙŠÙ„Ùƒ ÙƒØ±Ø§Ø³Ø¨.</p>
    <button class="btn" style="background: white; color: black;" onclick="closeWarning()">ÙÙ‡Ù…ØªØŒ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø­Ù„</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA03R-ytzQ26LhEDc2VKmJd_yFMHS2RRPg",
        authDomain: "eboro-93073.firebaseapp.com",
        databaseURL: "https://eboro-93073-default-rtdb.firebaseio.com",
        projectId: "eboro-93073",
        storageBucket: "eboro-93073.firebasestorage.app",
        messagingSenderId: "502542505811",
        appId: "1:502542505811:web:666af1eff94c5f1f9af3a6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentExam = null;
    let timerInterval;
    let timeRemaining;
    let warningsCount = 0;
    let isExamFinished = false;

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙƒÙŠØ² (Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ) ---
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    const inputs = ['student_name', 'student_code', 'exam_selector'];
    inputs.forEach(id => {
        const el = document.getElementById(id);
        el.addEventListener('input', () => {
            localStorage.setItem(id, el.value);
        });
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('load', () => {
        inputs.forEach(id => {
            if(localStorage.getItem(id)) {
                document.getElementById(id).value = localStorage.getItem(id);
            }
        });
    });

    // Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ù„
    function saveDraftAnswers() {
        const drafts = {};
        currentExam.questions.forEach((q, idx) => {
            if (q.type === 'mcq') {
                const sel = document.querySelector(`input[name="q${idx}"]:checked`);
                if (sel) drafts[`q${idx}`] = sel.value;
            } else {
                drafts[`q${idx}`] = document.getElementById(`q${idx}`).value;
            }
        });
        localStorage.setItem('exam_draft_answers', JSON.stringify(drafts));
    }

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    function loadDraftAnswers() {
        const drafts = JSON.parse(localStorage.getItem('exam_draft_answers') || '{}');
        Object.keys(drafts).forEach(key => {
            const input = document.getElementById(key);
            if (input && input.tagName === 'TEXTAREA') {
                input.value = drafts[key];
            } else {
                const radio = document.querySelector(`input[name="${key}"][value="${drafts[key]}"]`);
                if (radio) radio.checked = true;
            }
        });
    }

    // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
    async function loadExamsList() {
        const snap = await get(ref(db, 'exams'));
        if (snap.exists()) {
            const exams = snap.val();
            const selector = document.getElementById('exam_selector');
            Object.keys(exams).forEach(id => {
                let opt = document.createElement('option');
                opt.value = id;
                opt.innerText = exams[id].title;
                selector.appendChild(opt);
            });
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
            if(localStorage.getItem('exam_selector')) {
                selector.value = localStorage.getItem('exam_selector');
            }
        }
    }
    loadExamsList();

    window.startExam = async () => {
        const name = document.getElementById('student_name').value;
        const code = document.getElementById('student_code').value;
        const examId = document.getElementById('exam_selector').value;

        if (!name || !code || !examId) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");

        const snap = await get(ref(db, `exams/${examId}`));
        if (!snap.exists()) return;

        currentExam = snap.val();
        currentExam.id = examId;
        
        document.getElementById('login_screen').style.display = 'none';
        document.getElementById('exam_screen').style.display = 'block';
        document.getElementById('display_exam_title').innerText = currentExam.title;

        renderQuestions();
        loadDraftAnswers(); // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø£ÙŠ Ø­Ù„ Ù‚Ø¯ÙŠÙ…
        startTimer(currentExam.duration);
    };

    function renderQuestions() {
        const container = document.getElementById('questions_container');
        container.innerHTML = "";
        currentExam.questions.forEach((q, idx) => {
            let html = `<div class="question-card">
                <p><strong>Ø³${idx+1}:</strong> ${q.question}</p>`;
            
            if (q.type === 'mcq') {
                q.options.forEach((opt, i) => {
                    html += `<label>
                        <input type="radio" name="q${idx}" value="${i}" onchange="window.saveDraft()"> ${opt}
                    </label>`;
                });
            } else {
                html += `<textarea id="q${idx}" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..." oninput="window.saveDraft()"></textarea>`;
            }
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    // Ø±Ø¨Ø· ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù„ØªØ¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù€ HTML
    window.saveDraft = saveDraftAnswers;

    function startTimer(minutes) {
        timeRemaining = minutes * 60;
        timerInterval = setInterval(() => {
            let m = Math.floor(timeRemaining / 60);
            let s = timeRemaining % 60;
            document.getElementById('timer_display').innerText = `${m}:${s < 10 ? '0'+s : s}`;
            
            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                submitExam('timeout');
            }
            timeRemaining--;
        }, 1000);
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && !isExamFinished) {
            warningsCount++;
            if (warningsCount === 1) {
                document.getElementById('warning_overlay').style.display = 'flex';
            } else if (warningsCount >= 2) {
                submitExam('cheating');
            }
        }
    });

    window.closeWarning = () => {
        document.getElementById('warning_overlay').style.display = 'none';
    };

    window.submitExam = async (reason) => {
        if (isExamFinished) return;
        isExamFinished = true;
        clearInterval(timerInterval);

        const studentAnswers = [];
        currentExam.questions.forEach((q, idx) => {
            let val = "";
            if (q.type === 'mcq') {
                const sel = document.querySelector(`input[name="q${idx}"]:checked`);
                val = sel ? sel.value : "Ù„Ù… ÙŠØ­Ù„";
            } else {
                val = document.getElementById(`q${idx}`).value;
            }
            studentAnswers.push({ question: q.question, answer: val });
        });

        const submission = {
            student_name: document.getElementById('student_name').value,
            student_code: document.getElementById('student_code').value,
            exam_title: currentExam.title,
            answers: studentAnswers,
            status: reason === 'cheating' ? 'Ø±Ø§Ø³Ø¨ Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØºØ´' : (reason === 'timeout' ? 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª' : 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…'),
            submittedAt: new Date().toLocaleString('ar-EG')
        };

        try {
            await push(ref(db, 'exam_submissions'), submission);
            
            // Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­
            localStorage.removeItem('exam_draft_answers');
            localStorage.removeItem('exam_selector');

            document.body.innerHTML = `
                <div class="container">
                    <div class="end-screen">
                        <h1 style="color:${reason === 'cheating' ? '#ef4444' : '#22c55e'}">
                            ${reason === 'cheating' ? 'ğŸ”´ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ùƒ' : 'âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ'}
                        </h1>
                        <p style="font-size:18px; color:#64748b;">
                            ${reason === 'cheating' ? 'ØªÙ… Ø±ØµØ¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØºØ´ Ù…ØªÙƒØ±Ø±Ø© Ø¨Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØµÙØ­Ø©.' : 'Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ ÙˆØ±ØµØ¯ Ø¯Ø±Ø¬ØªÙƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.'}
                        </p>
                        <br>
                        <button class="btn" onclick="location.reload()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    </div>
                </div>`;
        } catch (e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©");
        }
    };
</script>

</body>
</html>