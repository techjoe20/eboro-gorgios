<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ | Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ø¤ÙˆØ±Ùˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #5D4037;
            --accent: #D4AF37;
            --bg: #F9F7F2;
            --success: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .payment_container {
            background: white;
            width: 90%;
            max-width: 450px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header_icon {
            font-size: 50px;
            color: var(--accent);
            margin-bottom: 15px;
        }

        h2 { color: var(--primary); margin-bottom: 10px; }
        p { color: #666; font-size: 14px; line-height: 1.6; }

        .method_selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        .method_btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        .method_btn.active {
            border-color: var(--accent);
            background-color: #fff9e6;
            color: var(--primary);
        }

        .instruction_box {
            background: #fff9e6;
            padding: 15px;
            border-radius: 10px;
            border-right: 5px solid var(--accent);
            margin: 20px 0;
            text-align: right;
        }

        .form_group {
            text-align: right;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: inherit;
        }

        .file_input_label {
            display: block;
            background: #eee;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn_submit {
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }

        .loading_overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 100;
        }

        #orange_section, #cash_section { display: none; }
        #orange_section.active, #cash_section.active { display: block; }

        @keyframes spin { to { transform: rotate(360deg); } }
        #preview_img { max-width: 100%; height: auto; margin-top: 10px; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div id="loading" class="loading_overlay">
    <div style="width: 50px; height: 50px; border: 5px solid #ddd; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <p id="loading_text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨...</p>
</div>

<div class="payment_container">
    <div class="header_icon">ğŸ’³</div>
    <h2>ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹</h2>
    <p>Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ØªÙŠ Ø§Ø³ØªØ®Ø¯Ù…ØªÙ‡Ø§:</p>

    <div class="method_selector">
        <div class="method_btn" id="btn_orange" onclick="showSection('orange')">Ø£ÙˆØ±Ù†Ø¬ ÙƒØ§Ø´</div>
        <div class="method_btn" id="btn_cash" onclick="showSection('cash')">Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹ (ÙƒØ§Ø´)</div>
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

    <div id="orange_section">
        <div class="instruction_box">Ø­ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù€ <strong>010XXXXXXXX</strong> Ø«Ù… Ø§Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¯Ù†Ø§Ù‡.</div>
        <div class="form_group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¨Ù‡ </label>
            <input type="text" id="student_phone_orange" placeholder="01XXXXXXXXX">
        </div>
        <div class="form_group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø°ÙŠ Ø­ÙˆÙ„Øª Ù…Ù†Ù‡</label>
            <input type="text" id="sender_phone" placeholder="01XXXXXXXXX">
        </div>
        <div class="form_group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <input type="text" id="process_id" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©">
        </div>
        <div class="form_group">
            <label for="receipt_file" class="file_input_label" id="file_label">
                <span>Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ ğŸ“·</span>
                <input type="file" id="receipt_file" accept="image/*" style="display: none;" onchange="previewImage(this)">
            </label>
            <img id="preview_img" src="#">
        </div>
        <button class="btn_submit" onclick="submitPayment('orange')">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
    </div>

    <div id="cash_section">
        <div class="instruction_box" style="border-right-color: var(--success);">
            Ø£Ø¯Ø®Ù„ <strong>Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</strong> Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¨Ù‡ Ùˆ <strong>ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</strong> Ù„ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ ÙÙˆØ±Ø§Ù‹.
        </div>
        <div class="form_group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¨Ù‡ </label>
            <input type="text" id="student_phone_cash" placeholder="01XXXXXXXXX">
        </div>
        <div class="form_group">
            <label>ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
            <input type="text" id="cash_code" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯">
        </div>
        <button class="btn_submit" style="background: var(--success);" onclick="submitPayment('cash')">ØªÙØ¹ÙŠÙ„ ÙˆØ¯Ø®ÙˆÙ„ ÙÙˆØ±ÙŠ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, get, remove, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA03R-ytzQ26LhEDc2VKmJd_yFMHS2RRPg",
        authDomain: "eboro-93073.firebaseapp.com",
        databaseURL: "https://eboro-93073-default-rtdb.firebaseio.com",
        projectId: "eboro-93073",
        storageBucket: "eboro-93073.firebasestorage.app",
        messagingSenderId: "502542505811",
        appId: "1:502542505811:web:666af1eff94c5f1f9af3a6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let base64Image = "";

    window.showSection = (type) => {
        document.getElementById('orange_section').style.display = type === 'orange' ? 'block' : 'none';
        document.getElementById('cash_section').style.display = type === 'cash' ? 'block' : 'none';
        document.getElementById('btn_orange').classList.toggle('active', type === 'orange');
        document.getElementById('btn_cash').classList.toggle('active', type === 'cash');
    };

    window.previewImage = (input) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview_img').src = e.target.result;
                document.getElementById('preview_img').style.display = 'block';
                document.getElementById('file_label').querySelector('span').innerText = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© âœ…";
                base64Image = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    };

    window.submitPayment = async (method) => {
        document.getElementById('loading').style.display = 'flex';
        
        try {
            if(method === 'orange') {
                const phoneReg = document.getElementById('student_phone_orange').value.trim();
                const sender = document.getElementById('sender_phone').value.trim();
                const process = document.getElementById('process_id').value.trim();

                if(!phoneReg || !sender || !process || !base64Image) throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

                await push(ref(db, 'payment_requests'), {
                    TEL01: phoneReg,
                    sender_phone: sender,
                    process_id: process,
                    receipt_image: base64Image,
                    status: "pending",
                    timestamp: new Date().toLocaleString('ar-EG')
                });

                Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!', text: 'Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³ØªØ± Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙˆØªÙØ¹ÙŠÙ„Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.' })
                .then(() => window.location.href = "index.html");

            } else {
                const phone = document.getElementById('student_phone_cash').value.trim();
                const code = document.getElementById('cash_code').value.trim();

                if(!phone || !code) throw new Error('Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙˆØ§Ù„ÙƒÙˆØ¯');

                // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
                const codeRef = ref(db, `cash_payment_codes/${code}`);
                const codeSnap = await get(codeRef);
                if (!codeSnap.exists()) throw new Error('ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹');

                // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨
                const studentsRef = ref(db, 'students');
                const studentQuery = query(studentsRef, orderByChild('TEL01'), equalTo(phone));
                const studentSnap = await get(studentQuery);

                if (!studentSnap.exists()) throw new Error('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‡Ø°Ø§ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§');

                const studentsData = studentSnap.val();
                const studentKey = Object.keys(studentsData)[0]; 

                // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø±Ù‚ Ø§Ù„ÙƒÙˆØ¯
                await update(ref(db, `students/${studentKey}`), { 
                    status: "active",
                    paymentMethod: "cash_code"
                });
                await remove(codeRef);

                // 4. Ø£Ù‡Ù… ØªØ¹Ø¯ÙŠÙ„: ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ØªÙ…Ø§Ù…Ø§Ù‹ ÙˆØ­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
                localStorage.clear(); // Ù…Ø³Ø­ Ø£ÙŠ Ø·Ø§Ù„Ø¨ Ù‚Ø¯ÙŠÙ… ÙƒØ§Ù† Ù…Ø³Ø¬Ù„
                
                const updatedStudent = { ...studentsData[studentKey], status: "active", id: studentKey };
                localStorage.setItem('studentCode', studentKey); // Ù„Ø­Ø³Ø§Ø¨ ØµÙØ­Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
                localStorage.setItem('loggedInStudent', JSON.stringify(updatedStudent));
                
                // 5. Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‚Ø§Ø·Ø¹
                Swal.fire({ 
                    icon: 'success', 
                    title: 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ!', 
                    text: 'Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ...',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = `student_profile.html?code=${studentKey}`; 
                });
            }
        } catch (e) {
            Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: e.message, confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹', direction: 'rtl' });
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    };
</script>

</body>
</html>