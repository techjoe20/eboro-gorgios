<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ | Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ø¤ÙˆØ±Ùˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #5D4037;
            --accent: #D4AF37;
            --bg: #F9F7F2;
            --success: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .payment_container {
            background: white;
            width: 90%;
            max-width: 450px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header_icon {
            font-size: 50px;
            color: var(--accent);
            margin-bottom: 15px;
        }

        h2 { color: var(--primary); margin-bottom: 10px; }
        p { color: #666; font-size: 14px; line-height: 1.6; }

        .method_selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        .method_btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        .method_btn.active {
            border-color: var(--accent);
            background-color: #fff9e6;
            color: var(--primary);
        }

        .instruction_box {
            background: #fff9e6;
            padding: 15px;
            border-radius: 10px;
            border-right: 5px solid var(--accent);
            margin: 20px 0;
            text-align: right;
        }

        .form_group {
            text-align: right;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: inherit;
        }

        .file_input_label {
            display: block;
            background: #eee;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn_submit {
            width: 100%;
            background: var(--primary);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
        }

        .loading_overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 100;
        }

        #orange_section, #cash_section { display: none; }
        #orange_section.active, #cash_section.active { display: block; }

        @keyframes spin { to { transform: rotate(360deg); } }
        #preview_img { max-width: 100%; height: auto; margin-top: 10px; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div id="loading" class="loading_overlay">
    <div style="width: 50px; height: 50px; border: 5px solid #ddd; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite;"></div>
    <p id="loading_text">Ø¬Ø§Ø±ÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙˆØ±Ø§Ù‹...</p>
</div>

<div class="payment_container">
    <div class="header_icon">ğŸ’³</div>
    <h2>ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹</h2>
    <p>Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ØªÙŠ Ø§Ø³ØªØ®Ø¯Ù…ØªÙ‡Ø§:</p>

    <div class="method_selector">
        <div class="method_btn" id="btn_orange" onclick="showSection('orange')">Ø£ÙˆØ±Ù†Ø¬ ÙƒØ§Ø´</div>
        <div class="method_btn" id="btn_cash" onclick="showSection('cash')">Ø¯ÙØ¹ Ù†Ù‚Ø¯Ø§Ù‹ (ÙƒØ§Ø´)</div>
    </div>

    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

    <div id="orange_section">
        <div class="instruction_box">Ø­ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù€ <strong>01201529126</strong> Ø«Ù… Ø§Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¯Ù†Ø§Ù‡.</div>
        <div class="form_group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¨Ù‡ </label>
            <input type="text" id="student_phone_orange" placeholder="01XXXXXXXXX">
        </div>
        <div class="form_group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø°ÙŠ Ø­ÙˆÙ„Øª Ù…Ù†Ù‡</label>
            <input type="text" id="sender_phone" placeholder="01XXXXXXXXX">
        </div>
        <div class="form_group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <input type="text" id="process_id" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©">
        </div>
        <div class="form_group">
            <label for="receipt_file" class="file_input_label" id="file_label">
                <span>Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ ğŸ“·</span>
                <input type="file" id="receipt_file" accept="image/*" style="display: none;" onchange="previewImage(this)">
            </label>
            <img id="preview_img" src="#">
        </div>
        <button class="btn_submit" onclick="submitPayment('orange')">ØªÙØ¹ÙŠÙ„ ÙÙˆØ±ÙŠ Ø§Ù„Ø¢Ù†</button>
    </div>

    <div id="cash_section">
        <div class="instruction_box" style="border-right-color: var(--success);">
            Ø£Ø¯Ø®Ù„ <strong>Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</strong> Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¨Ù‡ Ùˆ <strong>ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</strong> Ù„ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ ÙÙˆØ±Ø§Ù‹.
        </div>
        <div class="form_group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¬Ù„ Ø¨Ù‡ </label>
            <input type="text" id="student_phone_cash" placeholder="01XXXXXXXXX">
        </div>
        <div class="form_group">
            <label>ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ„Ù…</label>
            <input type="text" id="cash_code" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯">
        </div>
        <button class="btn_submit" style="background: var(--success);" onclick="submitPayment('cash')">ØªÙØ¹ÙŠÙ„ ÙˆØ¯Ø®ÙˆÙ„ ÙÙˆØ±ÙŠ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, get, remove, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA03R-ytzQ26LhEDc2VKmJd_yFMHS2RRPg",
        authDomain: "eboro-93073.firebaseapp.com",
        databaseURL: "https://eboro-93073-default-rtdb.firebaseio.com",
        projectId: "eboro-93073",
        storageBucket: "eboro-93073.firebasestorage.app",
        messagingSenderId: "502542505811",
        appId: "1:502542505811:web:666af1eff94c5f1f9af3a6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let base64Image = "";

    window.showSection = (type) => {
        document.getElementById('orange_section').style.display = type === 'orange' ? 'block' : 'none';
        document.getElementById('cash_section').style.display = type === 'cash' ? 'block' : 'none';
        document.getElementById('btn_orange').classList.toggle('active', type === 'orange');
        document.getElementById('btn_cash').classList.toggle('active', type === 'cash');
    };

    window.previewImage = (input) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview_img').src = e.target.result;
                document.getElementById('preview_img').style.display = 'block';
                document.getElementById('file_label').querySelector('span').innerText = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© âœ…";
                base64Image = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    };

    window.submitPayment = async (method) => {
        const loadingOverlay = document.getElementById('loading');
        loadingOverlay.style.display = 'flex';
        
        try {
            let phoneToQuery = "";
            let extraData = {};

            if(method === 'orange') {
                phoneToQuery = document.getElementById('student_phone_orange').value.trim();
                const sender = document.getElementById('sender_phone').value.trim();
                const process = document.getElementById('process_id').value.trim();
                if(!phoneToQuery || !sender || !process || !base64Image) throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ù„ØµÙˆØ±Ø©');
                
                extraData = { 
                    sender_phone: sender, 
                    process_id: process, 
                    receipt_image: base64Image,
                    method: "orange_cash" 
                };
            } else {
                phoneToQuery = document.getElementById('student_phone_cash').value.trim();
                const code = document.getElementById('cash_code').value.trim();
                if(!phoneToQuery || !code) throw new Error('Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ÙƒÙˆØ¯');

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
                let codeRef = ref(db, `cash_payment_codes/${code}`);
                let codeSnap = await get(codeRef);
                let foundCodePath = null;

                if (codeSnap.exists()) {
                    foundCodePath = `cash_payment_codes/${code}`;
                } else {
                    const codesRef = ref(db, 'cash_payment_codes');
                    const codeQuery = query(codesRef, orderByChild('code'), equalTo(code));
                    const secondSnap = await get(codeQuery);
                    if (secondSnap.exists()) {
                        const key = Object.keys(secondSnap.val())[0];
                        foundCodePath = `cash_payment_codes/${key}`;
                    }
                }
                if (!foundCodePath) throw new Error('ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­');
                
                extraData = { activation_code: code, method: "cash_code", codePath: foundCodePath };
            }

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªÙØ¹ÙŠÙ„Ù‡ (Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† Ø§Ù„Ø·Ø±ÙŠÙ‚ØªÙŠÙ†)
            const studentsRef = ref(db, 'students');
            const studentQuery = query(studentsRef, orderByChild('TEL01'), equalTo(phoneToQuery));
            const studentSnap = await get(studentQuery);

            if (!studentSnap.exists()) throw new Error('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‡Ø°Ø§ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§');

            const studentsData = studentSnap.val();
            const studentKey = Object.keys(studentsData)[0]; 
            const studentInfo = studentsData[studentKey];

            const student_name_val = studentInfo.USR01 || studentInfo.NAME || studentInfo.student_name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

            const updates = {};
            updates[`students/${studentKey}/status`] = "active";
            updates[`students/${studentKey}/paymentMethod`] = extraData.method;
            
            updates[`paid_history/${studentKey}`] = {
                student_name: student_name_val,
                TEL01: phoneToQuery,
                payment_date: new Date().toLocaleString('ar-EG'),
                method: extraData.method,
                ...extraData
            };

            await update(ref(db), updates);
            
            // Ù„Ùˆ ÙƒØ§Ø´ Ù†Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯
            if(method === 'cash' && extraData.codePath) {
                await remove(ref(db, extraData.codePath));
            }

            // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„
            localStorage.clear(); 
            localStorage.setItem('studentCode', studentKey);
            localStorage.setItem('loggedInStudent', JSON.stringify({ ...studentInfo, status: "active", id: studentKey }));
            
            loadingOverlay.style.display = 'none';
            await Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!', text: 'Ø¬Ø§Ø±ÙŠ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„Ø¢Ù†...', timer: 2000, showConfirmButton: false });
            window.location.href = `student_profile.html?code=${studentKey}`;

        } catch (e) {
            loadingOverlay.style.display = 'none';
            Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: e.message });
        }
    };
</script>
</body>
</html>