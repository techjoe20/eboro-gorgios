<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†ØªÙŠØ¬Ø© Ø§Ù…ØªØ­Ø§Ù† Ø¢Ø®Ø± Ø§Ù„Ø¹Ø§Ù… | Ù…Ø¯Ø±Ø³Ø© Ø§Ù„ÙƒÙ†ÙŠØ³Ø©</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --bg-body: #F4F1EA;
            --bg-card: #FFFFFF;
            --text-main: #5D4037;
            --text-sub: #8D6E63;
            --accent: #D4AF37;
            --card-border: #E0E0E0;
            --table-header: #5D4037;
        }

        body.dark-mode {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #b0b0b0;
            --accent: #D4AF37;
            --card-border: #333333;
            --table-header: #2c1d1a;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-body); margin: 0; padding: 20px; color: var(--text-main); transition: 0.3s; }
        
        .result_container { max-width: 600px; margin: 40px auto; background: var(--bg-card); padding: 30px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid var(--accent); text-align: center; }
        
        .header_icon { font-size: 50px; margin-bottom: 10px; }
        h2 { margin: 0; color: var(--text-main); }
        .sub_title { color: var(--accent); font-weight: bold; margin-bottom: 25px; display: block; }

        .search_box { margin-bottom: 30px; }
        input { padding: 12px; width: 70%; border-radius: 12px; border: 2px solid var(--card-border); background: var(--bg-body); color: var(--text-main); font-size: 16px; outline: none; text-align: center; }
        button { padding: 12px 25px; border-radius: 12px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { opacity: 0.9; transform: scale(1.05); }

        #resultCard { display: none; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .student_info { background: var(--bg-body); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--card-border); }
        .student_info div { margin-bottom: 5px; font-size: 14px; }
        .student_info strong { color: var(--accent); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; border-radius: 12px; overflow: hidden; }
        th { background: var(--table-header); color: white; padding: 12px; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid var(--card-border); background: var(--bg-card); font-weight: 600; }

        .total_score { margin-top: 20px; font-size: 20px; font-weight: 800; color: #2E7D32; }
        .failed { color: #C62828 !important; }
        
        .footer_msg { margin-top: 20px; font-style: italic; color: var(--text-sub); font-size: 13px; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø§Ø±Ùƒ Ù…ÙˆØ¯ */
        .theme-toggle { position: absolute; top: 20px; left: 20px; cursor: pointer; font-size: 24px; background: none; border: none; padding: 0; margin: 0; width: auto; }
    </style>
</head>
<body>

<button class="theme-toggle" onclick="toggleTheme()" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">ğŸŒ“</button>

<div class="result_container">
    <div class="header_icon">ğŸ“œ</div>
    <h2>Ù†ØªØ§Ø¦Ø¬ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø¢Ø®Ø± Ø§Ù„Ø¹Ø§Ù…</h2>
    <span class="sub_title">Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ø¤ÙˆØ±ÙˆØ¬ÙˆØ±Ø¬ÙŠÙˆØ³</span>

    <div class="search_box">
        <input type="text" id="studentCodeInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‡Ù†Ø§">
        <br>
        <button onclick="fetchResult()">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
    </div>

    <div id="resultCard">
        <div class="student_info">
            <div id="resName">Ø§Ù„Ø§Ø³Ù…: <strong>...</strong></div>
            <div id="resCode">ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: <strong>...</strong></div>
            <div id="resDate" style="display: none;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¹: <strong>...</strong></div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                    <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                    <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                </tr>
            </thead>
            <tbody id="gradesTable"></tbody>
        </table>

        <div class="total_score" id="totalScore">
            Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: <span>0</span>
        </div>
        
        <p class="footer_msg">"Ø§Ù„Ù†Ø¬Ø§Ø­ Ù‡Ùˆ Ø«Ù…Ø±Ø© Ø§Ù„Ø§Ø¬ØªÙ‡Ø§Ø¯.. Ù…Ø¨Ø±ÙˆÙƒ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø§Ø¬Ø­ÙŠÙ†"</p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA03R-ytzQ26LhEDc2VKmJd_yFMHS2RRPg",
        authDomain: "eboro-93073.firebaseapp.com",
        databaseURL: "https://eboro-93073-default-rtdb.firebaseio.com",
        projectId: "eboro-93073",
        storageBucket: "eboro-93073.firebasestorage.app",
        messagingSenderId: "502542505811",
        appId: "1:502542505811:web:666af1eff94c5f1f9af3a6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† (localStorage) ---

    // 1. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¸Ù‡Ø± ÙˆØ­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙƒØªÙˆØ¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.addEventListener('DOMContentLoaded', () => {
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¸Ù‡Ø±
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
        
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± ÙƒÙˆØ¯ ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡
        const savedCode = localStorage.getItem('lastSearchedCode');
        if (savedCode) {
            document.getElementById('studentCodeInput').value = savedCode;
        }
    });

    // 2. ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø± Ù…Ø¹ Ø§Ù„Ø­ÙØ¸
    window.toggleTheme = function() {
        document.body.classList.toggle('dark-mode');
        const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
        localStorage.setItem('theme', theme);
    }

    // 3. Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
    window.fetchResult = async function() {
        const codeInput = document.getElementById('studentCodeInput');
        const code = codeInput.value.trim();
        const resultCard = document.getElementById('resultCard');
        
        if (!code) {
            Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹', 'info');
            return;
        }

        // Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„ÙŠØ¨Ù‚Ù‰ Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø§Ù„Ù€ Reload
        localStorage.setItem('lastSearchedCode', code);

        Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

        try {
            const studentRef = ref(db, 'exam_results/' + code);
            const snapshot = await get(studentRef);

            if (snapshot.exists()) {
                const data = snapshot.val();
                
                document.getElementById('resName').innerHTML = `Ø§Ù„Ø§Ø³Ù…: <strong>${data.studentName || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</strong>`;
                document.getElementById('resCode').innerHTML = `ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨: <strong>${code}</strong>`;
                document.getElementById('resDate').innerHTML = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ØªÙŠØ¬Ø©: <strong>${data.date || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</strong>`;

                let tableHTML = "";
                
                const subjectNames = {
                    agpeya: "Ø§Ù„Ø£Ø¬Ø¨ÙŠØ©",
                    taks: "Ø§Ù„Ø·Ù‚Ø³",
                    spiritual: "Ø±ÙˆØ­ÙŠ",
                    alhan: "Ø£Ù„Ø­Ø§Ù†",
                    behavior: "Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…",
                    lectures: "Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª"
                };

                if (data.scores) {
                    Object.entries(data.scores).forEach(([key, score]) => {
                        let scoreVal = parseFloat(score);
                        let gradeText = scoreVal >= 50 ? "Ù†Ø§Ø¬Ø­" : "Ø±Ø§Ø³Ø¨";
                        let gradeClass = scoreVal < 50 ? "failed" : "";
                        
                        tableHTML += `<tr>
                            <td>${subjectNames[key] || key}</td>
                            <td>${scoreVal}</td>
                            <td class="${gradeClass}">${gradeText}</td>
                        </tr>`;
                    });
                }

                document.getElementById('gradesTable').innerHTML = tableHTML;
                document.getElementById('totalScore').innerHTML = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${data.totalScore} <br> <small>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: ${data.percentage}%</small>`;
                
                Swal.close();
                resultCard.style.display = 'block';
            } else {
                Swal.fire('Ù†Ø¹ØªØ°Ø±', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯.', 'warning');
                resultCard.style.display = 'none';
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
        }
    }
</script>
</body>
</html>