<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</title>
    <style>
        :root {
            --bg01: #f8fafc;
            --primary01: #1e293b;
            --accent01: #d4af37;
            --text01: #334155;
            --unread-bg: #eff6ff;
            --unread-border: #3b82f6;
            --box-bg: #ffffff;
            --item-border: #f1f5f9;
        }

        body.dark_mode_active {
            --bg01: #000000;
            --primary01: #f1f5f9;
            --accent01: #d4af37;
            --text01: #cbd5e1;
            --unread-bg: #121212;
            --unread-border: #3b82f6;
            --box-bg: #0a0a0a;
            --item-border: #1e1e1e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg01);
            color: var(--text01);
            margin: 0; padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        .main_box {
            max-width: 600px;
            margin: 40px auto;
            background: var(--box-bg);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 25px;
        }

        .header_box {
            border-bottom: 2px solid var(--bg01);
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header_box h2 { margin: 0; font-size: 1.4rem; color: var(--primary01); }

        .msg_item {
            background: var(--box-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--item-border);
            border-right: 5px solid #e2e8f0;
            position: relative;
            transition: 0.3s;
            cursor: pointer;
        }

        .msg_item.unread {
            background: var(--unread-bg);
            border-right-color: var(--unread-border);
        }

        .unread_badge {
            display: none;
            background: var(--unread-border);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            float: left;
        }

        .msg_item.unread .unread_badge { display: inline-block; }
        .msg_date { font-size: 0.8rem; color: #64748b; display: block; margin-bottom: 8px; }
        .msg_content { line-height: 1.6; white-space: pre-wrap; margin-bottom: 10px; }

        .btn_dombo {
            background: var(--accent01);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            font-weight: bold;
        }

        .empty_state { text-align: center; padding: 50px 20px; }
        .btn_refresh {
            display: block; width: 100%; padding: 12px;
            background: var(--primary01); color: var(--bg01);
            border: none; border-radius: 8px; cursor: pointer;
            margin-top: 20px; font-weight: bold;
        }
    </style>
</head>
<body>

<script>
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark_mode_active');
    }
</script>

<div class="main_box">
    <div class="header_box">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span>ğŸ“©</span>
            <h2>Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</h2>
        </div>
    </div>

    <div class="msg_list" id="msgList01">
        <div class="empty_state">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
    </div>

    <button class="btn_refresh" onclick="location.reload()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA03R-ytzQ26LhEDc2VKmJd_yFMHS2RRPg",
        authDomain: "eboro-93073.firebaseapp.com",
        databaseURL: "https://eboro-93073-default-rtdb.firebaseio.com",
        projectId: "eboro-93073",
        storageBucket: "eboro-93073.firebasestorage.app",
        messagingSenderId: "502542505811",
        appId: "1:502542505811:web:666af1eff94c5f1f9af3a6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function getReadMessages() {
        return JSON.parse(localStorage.getItem('read_announcements') || '[]');
    }

    window.markAsRead = (id) => {
        let readMsgs = getReadMessages();
        if (!readMsgs.includes(id)) {
            readMsgs.push(id);
            localStorage.setItem('read_announcements', JSON.stringify(readMsgs));
            renderMessages(); 
        }
    };

    let cachedData = null;
    let userStudentCode = ""; 

    async function renderMessages() {
        if (!cachedData) return;
        
        const msgListContainer = document.getElementById('msgList01');
        const readMsgs = getReadMessages();
        let html = "";

        const msgsArray = Object.keys(cachedData).map(key => ({
            id: key,
            ...cachedData[key]
        })).sort((a, b) => b.timestamp - a.timestamp);

        // Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¹Ø§Ù… (all) ÙˆØ§Ù„Ø®Ø§Øµ (studentCode)
        const filteredMsgs = msgsArray.filter(msg => {
            const target = String(msg.target || "").trim().toLowerCase();
            const studentCode = String(userStudentCode).trim().toLowerCase();
            
            // Ø§Ù„Ø´Ø±Ø·: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‡Ø¯Ù Ù„Ù„ÙƒÙ„ OR Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‡Ø¯Ù Ù‡Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯Ø§Ù‹
            return target === "all" || target === studentCode;
        });

        if (filteredMsgs.length === 0) {
            msgListContainer.innerHTML = `<div class="empty_state"><span class="empty_icon">ğŸ“‹</span><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù…ÙˆØ¬Ù‡Ø© Ø¥Ù„ÙŠÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹</h3></div>`;
            return;
        }

        filteredMsgs.forEach(msg => {
            const isUnread = !readMsgs.includes(msg.id);
            html += `
                <div class="msg_item ${isUnread ? 'unread' : ''}" onclick="markAsRead('${msg.id}')">
                    <span class="unread_badge">Ø¬Ø¯ÙŠØ¯</span>
                    <span class="msg_date">${msg.date}</span>
                    <div class="msg_content">${msg.content}</div>
                    ${isUnread ? '<button class="btn_dombo">Ø§Ø¶ØºØ· Ù„ØªØ§ÙƒÙŠØ¯ Ø§Ù„Ù‚Ø±Ø§Ø¦Ø©</button>' : '<small style="color:#2ecc71">ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© âœ…</small>'}
                </div>
            `;
        });

        msgListContainer.innerHTML = html;
    }

    async function initPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const studentKey = urlParams.get('code');

        if (!studentKey) {
            document.getElementById('msgList01').innerHTML = `<div class="empty_state">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ©</div>`;
            return;
        }

        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù€ STUDENT_CODE Ù…Ù† ÙØ±Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù‡
            const studentRef = ref(db, 'students/' + studentKey);
            const snapshot = await get(studentRef);
            
            if (snapshot.exists()) {
                // Ù†Ø£Ø®Ø° Ø§Ù„Ù€ STUDENT_CODE Ø£Ùˆ Ù†Ø³ØªØ®Ø¯Ù… Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ§Ø­ØªÙŠØ§Ø·ÙŠ
                userStudentCode = snapshot.val().STUDENT_CODE || studentKey;
            } else {
                userStudentCode = studentKey;
            }

            const announcementsRef = ref(db, 'announcements');
            onValue(announcementsRef, (snap) => {
                if (snap.exists()) {
                    cachedData = snap.val();
                    renderMessages();
                } else {
                    document.getElementById('msgList01').innerHTML = `<div class="empty_state"><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹</h3></div>`;
                }
            });

        } catch (error) {
            console.error("Firebase Error:", error);
        }
    }

    initPage();
</script>

</body>
</html>