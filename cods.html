<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { 
            --admin-color: #1e293b; --accent-color: #d4af37; --bg-color: #f8fafc; 
            --text-main: #334155; --success: #10b981; --danger: #ef4444; --info: #3b82f6;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: var(--text-main); }
        
        .header { background: linear-gradient(135deg, var(--admin-color) 0%, #334155 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; text-decoration: none; font-size: 14px; }
        
        .msg_form { background: white; padding: 30px; border-radius: 20px; max-width: 900px; margin: 0 auto; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .code-input { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; text-align: center; font-size: 1.5em; letter-spacing: 3px; background: #f1f5f9; font-family: monospace; box-sizing: border-box; }
        
        .btn-gen { width: 100%; padding: 15px; background: var(--admin-color); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-bottom: 10px; font-size: 1.1em; }
        .btn-gen:hover { background: var(--accent-color); color: var(--admin-color); }

        .table_outer { background: white; border-radius: 15px; border: 1px solid #e2e8f0; overflow: hidden; margin-top: 20px; }
        .table_responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th, td { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        thead { background: #f8fafc; }

        .code-badge { background:#e0f2fe; padding:5px 10px; border-radius:5px; font-family: monospace; font-weight: bold; color: var(--info); }
        .status-claimed { color: var(--danger); font-weight: bold; display: block; }
        .status-available { color: var(--success); font-weight: bold; }
        .student-ref { font-size: 0.85em; color: #64748b; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; margin-top: 5px; display: inline-block; }
        .btn-del { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 6px 12px; border-radius: 6px; cursor: pointer; }

        .count-display { background: #f1f5f9; padding: 5px 15px; border-radius: 8px; font-weight: bold; border: 1px solid #e2e8f0; font-size: 0.9em; }

        .bulk-ctrl { display: flex; gap: 10px; margin-bottom: 30px; }
        .bulk-ctrl input { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold; }
        .bulk-ctrl button { flex: 2; padding: 10px; border-radius: 10px; border: none; background: var(--success); color: white; font-weight: bold; cursor: pointer; }

        /* Ø³ØªØ§ÙŠÙ„ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ */
        .batch-actions { background: #fff5f5; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; border: 1px solid #fed7d7; }
        .btn-del-bulk { background: var(--danger); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .select-all-wrap { display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h2 style="margin:0">Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¯Ø®ÙˆÙ„ ğŸ”‘</h2>
            <p style="margin:5px 0 0; opacity:0.8">Ù†Ø¸Ø§Ù… Ø­Ø±Ù‚ ÙˆØªØ®ØµÙŠØµ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</p>
        </div>
        <a href="admin-study.html" class="back-btn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â®•</a>
    </div>

    <div class="msg_form">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin:0">ØªÙˆÙ„ÙŠØ¯ Ø£ÙƒÙˆØ§Ø¯ Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div class="count-display">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: <span id="total_codes_count" style="color:var(--info)">0</span></div>
        </div>

        <input type="text" id="new_entry_code" readonly placeholder="********" class="code-input">
        <button class="btn-gen" id="btnAutoGenerate">ØªÙˆÙ„ÙŠØ¯ ÙˆØ­ÙØ¸ ÙƒÙˆØ¯ ÙˆØ§Ø­Ø¯ âœ¨</button>

        <div class="bulk-ctrl">
            <input type="number" id="bulk_count" min="1" max="50" value="5" placeholder="Ø§Ù„Ø¹Ø¯Ø¯">
            <button id="btnBulkGenerate">ØªÙˆÙ„ÙŠØ¯ ÙƒÙ…ÙŠØ© Ø£ÙƒÙˆØ§Ø¯ Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø© ğŸš€</button>
        </div>

        <div class="batch-actions">
            <label class="select-all-wrap">
                <input type="checkbox" id="selectAllCodes" style="transform: scale(1.3);"> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
            </label>
            <button class="btn-del-bulk" id="btnDeleteSelected">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ ğŸ—‘ï¸</button>
            <small style="color: #666;">(ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø³Ù…ÙŠÙ†: Ø§Ù„Ù…ØªØ§Ø­ ÙˆØ§Ù„Ù…Ø­Ø¬ÙˆØ²)</small>
        </div>
        
        <div class="table_outer">
            <div class="table_responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ØªØ­Ø¯ÙŠØ¯</th>
                            <th>Ø§Ù„ÙƒÙˆØ¯</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø© / Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="codes_table">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA03R-ytzQ26LhEDc2VKmJd_yFMHS2RRPg",
            authDomain: "eboro-93073.firebaseapp.com",
            databaseURL: "https://eboro-93073-default-rtdb.firebaseio.com",
            projectId: "eboro-93073",
            storageBucket: "eboro-93073.firebasestorage.app",
            messagingSenderId: "502542505811",
            appId: "1:502542505811:web:666af1eff94c5f1f9af3a6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        function generateRandomCode(length = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) { result += chars.charAt(Math.floor(Math.random() * chars.length)); }
            return result;
        }

        async function saveCodeToDB(code) {
            return set(ref(db, 'allowed_codes/' + code), { 
                code: code, 
                dateAdded: new Date().toLocaleString('ar-EG'), 
                timestamp: Date.now()
            });
        }

        document.getElementById('btnAutoGenerate').onclick = async () => {
            const newCode = generateRandomCode(8);
            document.getElementById('new_entry_code').value = newCode;
            try {
                await saveCodeToDB(newCode);
                Swal.fire('ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯', 'Ø§Ù„ÙƒÙˆØ¯ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù† Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…', 'success');
            } catch (e) { Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯', 'error'); }
        };

        document.getElementById('btnBulkGenerate').onclick = async () => {
            const count = parseInt(document.getElementById('bulk_count').value);
            if (count < 1 || count > 100) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ø¨ÙŠÙ† 1 Ùˆ 100', 'warning');
            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆÙ„ÙŠØ¯...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
            try {
                for (let i = 0; i < count; i++) {
                    const newCode = generateRandomCode(8);
                    await saveCodeToDB(newCode);
                }
                Swal.fire('Ù†Ø¬Ø§Ø­', `ØªÙ… ØªÙˆÙ„ÙŠØ¯ ${count} ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­`, 'success');
            } catch (e) { Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ', 'error'); }
        };

        function loadCodes() {
            onValue(ref(db, 'allowed_codes'), (availSnap) => {
                onValue(ref(db, 'bound_codes'), (boundSnap) => {
                    onValue(ref(db, 'students'), (studentsSnap) => {
                        const availData = availSnap.val() || {};
                        const boundData = boundSnap.val() || {};
                        const studentsData = studentsSnap.val() || {};
                        let html = "";

                        const total = Object.keys(availData).length + Object.keys(boundData).length;
                        document.getElementById('total_codes_count').innerText = total;

                        // Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©
                        Object.keys(boundData).reverse().forEach(key => {
                            const info = boundData[key];
                            const sID = info.student_code;
                            const sName = (studentsData[sID] && studentsData[sID].USR01) ? studentsData[sID].USR01 : "Ø§Ø³Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„";
                            
                            html += `
                            <tr style="background-color: #fff8f8;">
                                <td><input type="checkbox" class="code-checkbox" data-id="${key}" data-path="bound_codes"></td>
                                <td><span class="code-badge" style="color:#ef4444; background:#fee2e2;">${key}</span></td>
                                <td><small>ØªÙ… Ø§Ù„Ø­Ø¬Ø²</small></td>
                                <td>
                                    <span class="status-claimed">ğŸš« Ù…Ø­Ø¬ÙˆØ²: ${sName}</span>
                                    <span class="student-ref">ID: ${sID || '---'}</span>
                                </td>
                                <td><button class="btn-del" onclick="deleteEntry('${key}', 'bound_codes')">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button></td>
                            </tr>`;
                        });

                        // Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©
                        Object.keys(availData).sort((a,b) => availData[b].timestamp - availData[a].timestamp).forEach(key => {
                            const c = availData[key];
                            html += `
                            <tr>
                                <td><input type="checkbox" class="code-checkbox" data-id="${key}" data-path="allowed_codes"></td>
                                <td><span class="code-badge">${c.code}</span></td>
                                <td><small>${c.dateAdded}</small></td>
                                <td><span class="status-available">âœ… Ù…ØªØ§Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</span></td>
                                <td><button class="btn-del" onclick="deleteEntry('${key}', 'allowed_codes')">Ø­Ø°Ù</button></td>
                            </tr>`;
                        });

                        document.getElementById('codes_table').innerHTML = html || "<tr><td colspan='5'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
                    });
                });
            });
        }

        // ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
        document.getElementById('selectAllCodes').onchange = function() {
            const checkboxes = document.querySelectorAll('.code-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
        };

        // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
        document.getElementById('btnDeleteSelected').onclick = async () => {
            const selected = document.querySelectorAll('.code-checkbox:checked');
            if (selected.length === 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§ Ø£ÙˆÙ„Ø§Ù‹', 'info');

            const result = await Swal.fire({
                title: 'Ø­Ø°Ù Ø¬Ù…Ø§Ø¹ÙŠØŸ',
                text: `Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø­Ø°Ù ${selected.length} Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„ÙƒÙ„'
            });

            if (result.isConfirmed) {
                Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                try {
                    for (let cb of selected) {
                        const id = cb.getAttribute('data-id');
                        const path = cb.getAttribute('data-path');
                        await remove(ref(db, `${path}/${id}`));
                    }
                    document.getElementById('selectAllCodes').checked = false;
                    Swal.fire('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'ØªÙ… ØªØ·Ù‡ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©', 'success');
                } catch (e) {
                    Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù', 'error');
                }
            }
        };

        window.deleteEntry = (id, path) => {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù'
            }).then((result) => {
                if (result.isConfirmed) remove(ref(db, `${path}/${id}`));
            });
        };

        loadCodes();
    </script>
</body>
</html>